%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#1E3A5F', 'primaryTextColor': '#fff', 'primaryBorderColor': '#1E3A5F', 'lineColor': '#2E8B57', 'secondaryColor': '#E8F5E9', 'tertiaryColor': '#FFF3E0'}}}%%

graph TD
    subgraph INPUT["üìÅ INPUT LAYER"]
        A["üìÑ Upload .bib File"] --> B["üîç Parse Bibliography"]
        B --> C["üìä Normalize Metadata"]
    end
    
    subgraph SEARCH["üîé SEARCH AGENT"]
        C --> D["üß† Generate Boolean Query"]
        D --> E["üåê Execute Scopus API"]
        E --> F{"Results > 0?"}
        F -->|"‚ùå No"| G["üîÑ Refine Query"]
        G --> D
        F -->|"‚úÖ Yes"| H["üóëÔ∏è Deduplicate"]
    end
    
    subgraph SCREENING["üî¨ SCREENING AGENT"]
        H --> I["üìë Title Screening"]
        I --> J["üìù Abstract Screening"]
        J --> K{"Meets Criteria?"}
        K -->|"‚úÖ Yes"| L["‚úì Include"]
        K -->|"‚ùå No"| M["‚úó Exclude"]
        K -->|"‚ùì Uncertain"| N["üë§ Human Queue"]
    end
    
    subgraph ACQUISITION["üì• SCROUNGER AGENT - Waterfall Retrieval"]
        L --> O{"1Ô∏è‚É£ Unpaywall"}
        O -->|"‚úÖ Found"| P["üìÑ Download PDF"]
        O -->|"‚ùå Not Found"| Q{"2Ô∏è‚É£ CORE"}
        Q -->|"‚úÖ Found"| P
        Q -->|"‚ùå Not Found"| R{"3Ô∏è‚É£ ArXiv"}
        R -->|"‚úÖ Found"| P
        R -->|"‚ùå Not Found"| S["4Ô∏è‚É£ Virtual Full-Text"]
        S --> T["üìö Citation Context"]
        T --> U["üß† Semantic Expansion"]
    end
    
    subgraph QUALITY["‚öñÔ∏è EVALUATOR AGENT - JBI Framework"]
        P --> V["üî¨ Extract Study Design"]
        U --> V
        V --> W["üìä Sample Size Analysis"]
        W --> X["üéØ Control Group Check"]
        X --> Y["üé≤ Randomization Score"]
        Y --> Z["üìà Quality Score"]
        Z --> AA{"Score Category"}
        AA -->|"üü¢ High/Moderate"| AB["‚úì Synthesis"]
        AA -->|"üü° Low"| AC["üìä Sensitivity"]
        AA -->|"üî¥ Critical"| AD["‚úó Exclude"]
    end
    
    subgraph OUTPUT["üìä OUTPUT LAYER"]
        AB --> AE["üìã PRISMA Flowchart"]
        AC --> AE
        AD --> AE
        AE --> AF["üìë Synthesis Table"]
        AF --> AG["üñ•Ô∏è Streamlit Dashboard"]
    end
    
    style INPUT fill:#E3F2FD,stroke:#1E3A5F,stroke-width:2px
    style SEARCH fill:#FFF3E0,stroke:#E67E22,stroke-width:2px
    style SCREENING fill:#E8F5E9,stroke:#2E8B57,stroke-width:2px
    style ACQUISITION fill:#FCE4EC,stroke:#C2185B,stroke-width:2px
    style QUALITY fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px
    style OUTPUT fill:#E0F7FA,stroke:#00838F,stroke-width:2px
